<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Embedded Elixir</title>
  
  <meta name="author" content="Curated by Frank Hunleth"/>
  <meta name="generator" content="Hugo 0.40.2" />
  <link href='https://embedded-elixir.com//images/favicon.ico' rel='icon' type='image/x-icon'/>

  <link rel="alternate" href="https://embedded-elixir.com/index.xml" type="application/rss+xml" title="Embedded Elixir">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://embedded-elixir.com//css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://embedded-elixir.com//css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://embedded-elixir.com//css/highlight.min.css" />
  <link rel="stylesheet" href="https://embedded-elixir.com//css/pswp-gallery.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />

  
  

  
    <meta property="og:title" content="Reverting firmware updates" />
  

  
    <meta property="og:description" content="Deployed a firmware image that doesn&amp;amp;rsquo;t quite work? Made a mistake in development and don&amp;amp;rsquo;t want to remove and reprogram the MicroSD card to go back? No problem. If the previous …">
  

  <meta property="og:type" content="website" />

  
    <meta property="og:url" content="https://embedded-elixir.com/post/2018-01-08-firmware-revert/" />
    <link rel="canonical" href="https://embedded-elixir.com/post/2018-01-08-firmware-revert/" />
  

  
    <meta property="og:image" content="https://embedded-elixir.com/images/logo.png" />
  

  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <meta name="twitter:creator" content="@" />

  
    <meta name="twitter:title" content="Reverting firmware updates" />
  

  
    <meta name="twitter:description" content="Deployed a firmware image that doesn&amp;amp;rsquo;t quite work? Made a mistake in development and don&amp;amp;rsquo;t want to remove and reprogram the MicroSD card to go back? No problem. If the previous …">
  

  
    <meta name="twitter:image" content="https://embedded-elixir.com/images/logo.png" />
  

</head>



  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://embedded-elixir.com/">Embedded Elixir</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Embedded Elixir" href="https://embedded-elixir.com/">
            <img class="avatar-img" src="https://embedded-elixir.com//images/logo.png" alt="Embedded Elixir" />
          </a>
        
      </div>
    </div>

  </div>
</nav>

    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Reverting firmware updates</h1>
                
                
                  <span class="post-meta">Posted
                                           by Frank Hunleth 
                                          on January 8, 2018
                  </span>
                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>




    <div class="container" role="main">
      
        <div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>Deployed a firmware image that doesn&rsquo;t quite work? Made a mistake in development
and don&rsquo;t want to remove and reprogram the MicroSD card to go back? No problem.
If the previous firmware image worked fine, then just revert back to it.</p>

<p>This is one of those features that has been possible since the beginning of the
Nerves project, but we didn&rsquo;t make it easy. That&rsquo;s changing.</p>

<p></p>

<p>Let&rsquo;s go through a simple example. Imagine that you&rsquo;ve created a trivial
application that uses <a href="https://github.com/nerves-project/nerves_init_gadget">nerves_init_gadget</a> and loaded on a
Raspberry Pi Zero. It doesn&rsquo;t do anything, but you can connect to its IEx prompt
via a virtual serial port and upload firmware. Here&rsquo;s a list of its metadata:</p>

<pre><code class="language-elixir">iex&gt; Nerves.Runtime.KV.get_all
%{
  &quot;a.nerves_fw_application_part0_devpath&quot; =&gt; &quot;/dev/mmcblk0p3&quot;,
  &quot;a.nerves_fw_application_part0_fstype&quot; =&gt; &quot;ext4&quot;,
  &quot;a.nerves_fw_application_part0_target&quot; =&gt; &quot;/root&quot;,
  &quot;a.nerves_fw_architecture&quot; =&gt; &quot;arm&quot;,
  &quot;a.nerves_fw_author&quot; =&gt; &quot;The Nerves Team&quot;,
  &quot;a.nerves_fw_description&quot; =&gt; &quot;&quot;,
  &quot;a.nerves_fw_misc&quot; =&gt; &quot;&quot;,
  &quot;a.nerves_fw_platform&quot; =&gt; &quot;rpi0&quot;,
  &quot;a.nerves_fw_product&quot; =&gt; &quot;starter&quot;,
  &quot;a.nerves_fw_vcs_identifier&quot; =&gt; &quot;&quot;,
  &quot;a.nerves_fw_version&quot; =&gt; &quot;0.1.0&quot;,
  &quot;nerves_fw_active&quot; =&gt; &quot;a&quot;,
  &quot;nerves_fw_devpath&quot; =&gt; &quot;/dev/mmcblk0&quot;
}
</code></pre>

<p>You can see information about the currently running firmware and that the active
firmware slot (<code>nerves_fw_active</code>) is the &ldquo;a&rdquo; slot. Nerves has two slots for
firmware images, so let&rsquo;s upload a new firmware image (version 0.1.1) to the RPi
Zero and reboot. If you&rsquo;re new to Nerves, check out the <code>nerves_init_gadget</code> and
<a href="https://hexdocs.pm/nerves/getting-started.html">Nerves Getting Started</a> docs for how to do this. Once the board
reboots, you can inspect the firmware metadata updates:</p>

<pre><code class="language-elixir">iex&gt; Nerves.Runtime.KV.get_all
%{
  &quot;a.nerves_fw_application_part0_devpath&quot; =&gt; &quot;/dev/mmcblk0p3&quot;,
  &quot;a.nerves_fw_application_part0_fstype&quot; =&gt; &quot;ext4&quot;,
  &quot;a.nerves_fw_application_part0_target&quot; =&gt; &quot;/root&quot;,
  &quot;a.nerves_fw_architecture&quot; =&gt; &quot;arm&quot;,
  &quot;a.nerves_fw_author&quot; =&gt; &quot;The Nerves Team&quot;,
  &quot;a.nerves_fw_description&quot; =&gt; &quot;&quot;,
  &quot;a.nerves_fw_misc&quot; =&gt; &quot;&quot;,
  &quot;a.nerves_fw_platform&quot; =&gt; &quot;rpi0&quot;,
  &quot;a.nerves_fw_product&quot; =&gt; &quot;starter&quot;,
  &quot;a.nerves_fw_vcs_identifier&quot; =&gt; &quot;&quot;,
  &quot;a.nerves_fw_version&quot; =&gt; &quot;0.1.0&quot;,
  &quot;b.nerves_fw_application_part0_devpath&quot; =&gt; &quot;/dev/mmcblk0p3&quot;,
  &quot;b.nerves_fw_application_part0_fstype&quot; =&gt; &quot;ext4&quot;,
  &quot;b.nerves_fw_application_part0_target&quot; =&gt; &quot;/root&quot;,
  &quot;b.nerves_fw_architecture&quot; =&gt; &quot;arm&quot;,
  &quot;b.nerves_fw_author&quot; =&gt; &quot;The Nerves Team&quot;,
  &quot;b.nerves_fw_description&quot; =&gt; &quot;&quot;,
  &quot;b.nerves_fw_misc&quot; =&gt; &quot;&quot;,
  &quot;b.nerves_fw_platform&quot; =&gt; &quot;rpi0&quot;,
  &quot;b.nerves_fw_product&quot; =&gt; &quot;starter&quot;,
  &quot;b.nerves_fw_vcs_identifier&quot; =&gt; &quot;&quot;,
  &quot;b.nerves_fw_version&quot; =&gt; &quot;0.1.1&quot;,
  &quot;nerves_fw_active&quot; =&gt; &quot;b&quot;,
  &quot;nerves_fw_devpath&quot; =&gt; &quot;/dev/mmcblk0&quot;
}
</code></pre>

<p>The important line above is that <code>nerves_fw_active</code> is now pointing to slot &ldquo;b&rdquo;.
If you&rsquo;ve uploaded firmware to Nerves devices using <code>nerves_firmware_ssh</code>,
you&rsquo;ll have seen this since it tells you which slot it updates. The other
important piece of information is that <code>b.nerves_fw_version</code> is indeed &ldquo;0.1.1&rdquo;
so you know it&rsquo;s the new firmware.</p>

<p>Imagine now that something is wrong with this firmware and you want to go back
to &ldquo;0.1.0&rdquo;. Just run this:</p>

<pre><code class="language-elixir">iex&gt; Nerves.Runtime.revert
</code></pre>

<p>The Raspberry Pi Zero will reboot. When it comes up again, we can inspect the
firmware metadata to see what happened:</p>

<pre><code class="language-elixir">iex&gt; Nerves.Runtime.KV.get_all
%{
  &quot;a.nerves_fw_application_part0_devpath&quot; =&gt; &quot;/dev/mmcblk0p3&quot;,
  &quot;a.nerves_fw_application_part0_fstype&quot; =&gt; &quot;ext4&quot;,
  &quot;a.nerves_fw_application_part0_target&quot; =&gt; &quot;/root&quot;,
  &quot;a.nerves_fw_architecture&quot; =&gt; &quot;arm&quot;,
  &quot;a.nerves_fw_author&quot; =&gt; &quot;The Nerves Team&quot;,
  &quot;a.nerves_fw_description&quot; =&gt; &quot;&quot;,
  &quot;a.nerves_fw_misc&quot; =&gt; &quot;&quot;,
  &quot;a.nerves_fw_platform&quot; =&gt; &quot;rpi0&quot;,
  &quot;a.nerves_fw_product&quot; =&gt; &quot;starter&quot;,
  &quot;a.nerves_fw_vcs_identifier&quot; =&gt; &quot;&quot;,
  &quot;a.nerves_fw_version&quot; =&gt; &quot;0.1.0&quot;,
  &quot;b.nerves_fw_application_part0_devpath&quot; =&gt; &quot;/dev/mmcblk0p3&quot;,
  &quot;b.nerves_fw_application_part0_fstype&quot; =&gt; &quot;ext4&quot;,
  &quot;b.nerves_fw_application_part0_target&quot; =&gt; &quot;/root&quot;,
  &quot;b.nerves_fw_architecture&quot; =&gt; &quot;arm&quot;,
  &quot;b.nerves_fw_author&quot; =&gt; &quot;The Nerves Team&quot;,
  &quot;b.nerves_fw_description&quot; =&gt; &quot;&quot;,
  &quot;b.nerves_fw_misc&quot; =&gt; &quot;&quot;,
  &quot;b.nerves_fw_platform&quot; =&gt; &quot;rpi0&quot;,
  &quot;b.nerves_fw_product&quot; =&gt; &quot;starter&quot;,
  &quot;b.nerves_fw_vcs_identifier&quot; =&gt; &quot;&quot;,
  &quot;b.nerves_fw_version&quot; =&gt; &quot;0.1.1&quot;,
  &quot;nerves_fw_active&quot; =&gt; &quot;a&quot;,
  &quot;nerves_fw_devpath&quot; =&gt; &quot;/dev/mmcblk0&quot;
}
</code></pre>

<p>As you can see, the <code>nerves_fw_active</code> is back to &ldquo;a&rdquo; again. You can also revert
your revert to go back to the &ldquo;b&rdquo; slot again if you&rsquo;d like.</p>

<p>There are some limitations:</p>

<ol>
<li>Once you start uploading new firmware to a slot, that slot can&rsquo;t be reverted
to. This comes up when a firmware update fails part way so the slot is in a
half-written state.</li>
<li>The call to <code>revert</code> is manual. You can automate this in your application.
For example, if some self-checks fail, you could force a revert. Be sure to
think through your logic especially if any failures are transient.</li>
<li>You can&rsquo;t revert if the Erlang VM crashes or something horrible goes wrong
with loading <code>Nerves.Runtime</code>.</li>
</ol>

<p>That final limitation is an interesting one that can be overcome with some work.
Unfortunately, it&rsquo;s platform-specific. The general idea is that newly uploaded
firmware is in a provisional state. After it boots, it must do something to
confirm that it is &ldquo;good&rdquo;. For example, it could attempt to contact a firmware
update server. The idea is that if it can contact the update server, then it&rsquo;s
at least good enough to take a patch should anything else be wrong. If the
firmware image doesn&rsquo;t determine that it&rsquo;s &ldquo;good&rdquo;, then the next reboot reverts
back to the old image.</p>

<p>If you&rsquo;re interested in implementing this automatic fail-back feature on your
devices, check if your device runs the <a href="https://www.denx.de/wiki/U-Boot">U-Boot</a> bootloader or another
script-able bootloader. If it does, then the &ldquo;if&rdquo; statement that decides which
firmware slot to boot can be placed in there. If you don&rsquo;t have U-Boot (i.e.
you&rsquo;re using a Raspberry Pi), you can implement a less robust solution, but one
that may be sufficient for your use case. The idea is to call
<code>Nerves.Runtime.revert</code> as soon as possible in your code, but tell it not to
reboot the device. Then do whatever initialization, etc. that you need to tell
that the device is in good shape. If the device reboots at any point, it will
boot the old firmware. When your firmware determines that it&rsquo;s ok, &ldquo;revert&rdquo;
again to lock in the new firmware.</p>

<p>There are even more ways to ensure that your device can protect against buggy
firmware. As you&rsquo;d expect, this topic has quite a bit of depth that isn&rsquo;t
covered here. Nonetheless, Nerves can support many of these strategies since so
many low level details can be tweaked. If you need to implement something more
exotic and don&rsquo;t know where to look, post a question to the <a href="https://elixir-slackin.herokuapp.com/">elixir-lang
Slack</a>. It&rsquo;s possible that someone has a custom Nerves system
(possibly not public) that implements it.</p>
      </article>

      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="https://embedded-elixir.com/post/2018-01-08-windows-support/" data-toggle="tooltip" data-placement="top" title="The Road to Windows">&larr; Previous Post</a>
          </li>
        
        
          <li class="next">
            <a href="https://embedded-elixir.com/post/2018-05-03-nerves-v1.0.0/" data-toggle="tooltip" data-placement="top" title="Nerves v1.0 Released">Next Post &rarr;</a>
          </li>
        
      </ul>

      
        
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "embedded-elixir" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
        
      

    </div>
  </div>
</div>

      
    </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            Curated by Frank Hunleth
            &nbsp;&bull;&nbsp;
          

          2018

          
            &nbsp;&bull;&nbsp;
            <a href="https://embedded-elixir.com/">Embedded Elixir</a>
          
          <br>
          Contribute by submitting a PR to <a href="https://github.com/fhunleth/embedded-elixir">https://github.com/fhunleth/embedded-elixir</a>
        </p>
        
        <p class="credits theme-by text-muted">
        <a href="http://gohugo.io">Hugo v0.40.2</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> &nbsp;&bull;&nbsp; Logo based on <a href="https://thenounproject.com/search/?q=chip&i=751689">Processor Chip</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://embedded-elixir.com//js/pswp-init.js"></script>
<script src="https://embedded-elixir.com//js/main.js"></script>
<script src="https://embedded-elixir.com//js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> renderMathInElement(document.body); </script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-16709386-6', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
